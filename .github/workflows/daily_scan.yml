name: Daily AI Article Scan

on:
  schedule:
    - cron: '17 5 * * *'  # Runs at 05:17 UTC daily
  workflow_dispatch:      # Allows manual run

jobs:
  run-scanner:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install feedparser requests python-dotenv openai

- name: Find and Run Script
        env:
          # --- EXISTING SECRETS ---
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AI_SCANNER_STORAGE: ai_scanner_storage
          # --- NEW SECRETS (ADD THESE) ---
          EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        run: |
          # This command searches for the file and runs the first one it finds
          SCRIPT_PATH=$(find . -name "ai_article_scanner.py" -type f | head -n 1)
          
          if [ -z "$SCRIPT_PATH" ]; then
            echo "ERROR: Could not find ai_article_scanner.py anywhere in the repo."
            find . -maxdepth 3 -not -path '*/.*'
            exit 1
          else
            echo "Found script at: $SCRIPT_PATH"
            python "$SCRIPT_PATH"
          fi

      - name: Commit and Push State
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Only commit if the storage folder exists and has changes
          if [ -d "ai_scanner_storage" ]; then
            git add ai_scanner_storage/seen_store.json
            if git diff --staged --quiet; then
              echo "No changes to state file."
            else
              git commit -m "Update seen_store.json [skip ci]"
              git push
            fi
          fi
